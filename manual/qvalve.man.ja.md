# QVALVE(1)

## 名前

qvalve - 定量弁：データを指定された時に指定された量だけ出力

## 書式

```sh:
qvalve [-c|-l] [-t] [-p n] quantity [file [...]]
qvalve [-c|-l] [-t] [-p n] controlfile [file [...]]
```

## 説明

これは定量弁を模したコマンドです。すなわち、出力したい量（バイト数または行数）が指定されると、その量だけ標準出力へデータを送ります。controlfileを用いればいつでも、何回でも量を指定できるため、好きな時に好きな量だけデータを出力するという制御が行えます。

## 引数の説明

### file

データ源となるファイル。省略したり、`-`を指定した場合には標準出力と見なされます。複数指定することも可能です。

### quantity

出力する量（バイト数または行数）、または制御コマンド（[後述](#制御コマンド)）を指定します。それを量をバイト数で指定するか行数で指定するかは後述のオプション（-cまたは-l）で指定します。量を指定する書式は次のとおりです。

> [`+`]*n*[`.`*d*][*prefix*]

* *n*[`.`*d*]
  * 量を示すための数値。
  * *n*は整数であり、その直後に`.`*d*を付ければ小数を含む値も指定できますが、浮動小数点型（double型）由来の誤差が生じる可能性に注意が必要です。
* [*prefix*]
  * 倍数接頭辞
  * 使える文字列と意味は次のとおりです。
    * "`k`" ... 元の量の1000倍
    * "`M`" ... 元の量の1000^2倍
    * "`G`" ... 元の量の1000^3倍
    * "`T`" ... 元の量の1000^4倍
    * "`P`" ... 元の量の1000^5倍
    * "`E`" ... 元の量の1000^6倍
    * "`K`" ... 元の量の1024倍（慣用的）
    * "`ki`" ... 元の量の1024倍
    * "`Mi`" ... 元の量の1024^2倍
    * "`Gi`" ... 元の量の1024^3倍
    * "`Ti`" ... 元の量の1024^4倍
    * "`Pi`" ... 元の量の1024^5倍
    * "`Ei`" ... 元の量の1024^6倍
  * 無指定は1倍（元の量）です。
* [`+`]
  * 追加指定のための符号
  * 以前に指定した量の出力が終わっていない時、この符号を付けて量を指定すると、その未出力の残量に加算されます。
  * 以前に指定した量の出力が終わっていない時、この符号を付けずに量を指定すると、その未出力の残量は上書きされ、指定された量になります。

指定された量を出力し終えても、本コマンドはそれを理由に終了せず、入力ファイルがEOFになるのを待機します。詳細は、[コマンド終了に関する留意点](#コマンド終了に関する留意点)項を参照のこと。

#### 制御コマンド

出力する量の代わりに、動作を指示するコマンドを指定できます。現在指定できるものは次のとおりです。

* `t`
  * 出力を終え、qvalveコマンドを終了します。

### controlfile

quantityでは量を引数によって直接的に指定していたのに対し、この方法では量の書き込まれたファイルとしてcontrolfileを指定して間接的に指定します。本コマンドはcontrolfileの内容を監視するため、コマンド動作中に新しいパラメーターを書き込むことで量を追加したり変更できます。

書き込むパラメーターの書式はquantityと同じです。パラメーターとして無効な文字列が与えられた場合は、エラー終了せず、静かに無視します。有効なパラメーターがまだ何も与えられていない時のデフォルトは"0"です。

controlfileとして用いるファイルとしては、次のいずれかを選択できます。

#### 通常ファイル

controlfileとして通常ファイルを用いる場合、新しいパラメーターは必ず **新規作成モード（`O_CREAT`や`>`）** で書き込んでください。追記モード（`O_APPEND`や`>>`）で書き込んではいけません。理由は、通常ファイルの場合、このコマンドは常にファイルの先頭を監視するからです。

監視は0.1秒間隔で行われます。もし、書き込んだ新しいパラメーターを直ちに反映したいのであれば、ファイルを更新した後でこのコマンドに対してSIGHUPを送ってください。

#### キャラクタースペシャルファイルまたは名前付きパイプ

controlfileとしてこれらのいずれかを用いる場合、書き込むモードは上記のどちらでも構いません。また、パラメーター文字列の後に改行コード<LF>を付けることで直ちに反映されますのでシグナルを送る必要はありません。

パフォーマンスの観点からすると、通常ファイルよりこちらの方が有利です。

## オプション

### -c, -l

出力するデータ量の単位を指定します。-c、-lはそれぞれ量の単位を、バイト、行とすることを意味し、それぞれのオプションは互いに排他的です。これらがいずれも指定されなかった場合には-cが指定されたものと見なします。

バイト単位出力モードでは1バイト出力するごとにスリープし、行単位出力モードでは1行出力するごとにスリープします。

### -t

controlfileを利用していて、かつ、それがキャラクタースペシャルファイルまたは名前付きパイプである場合、それがEOFになると自動的にコマンドを終了します。つまりこのオプションを使えば、controlfileとして使っているキャラクタースペシャルファイルや名前付きパイプを閉じることでコマンドを終了させられます。

### -p *n*

（_POSIX_PRIORITY_SCHEDULINGをサポートしているOS限定）プロセス優先度設定。指定された量を送り終えた後はpthread_cond_wait()関数によって待機状態に入りますが、controlfileから1以上の量が設定されるとpthread_cond_signal()が送られて復帰します。この時、プロセス優先度が高ければ復帰までの待ち時間が短くなると期待されますが、このオプションの*n*値を2または3にすれば、プロセス優先度が上がります。*n*の範囲は0から3の4段階で、1がデフォルトです。

なお、このオプションを使うには管理者権限が必要な環境があるかもしれません。

## 戻り値

指定されたすべてのファイルを正常に処理できた場合にのみ0を戻し、引数・オプションが不正であった場合や一つでもファイル処理に失敗した場合には0以外を戻します。

## 使用例

ファイルa.txt、標準入力からのファイルb.txt、ファイルc.txtを、この順番に最初の2キビバイト（=2048バイト）だけ出力し、その後は待機し続ける。（もし入力データの総量が2キビバイト以下だった場合には終了する）

```sh:
$ cat b.txt | qvalve 2ki a.txt - c.txt
```

本コマンドのヘルプメッセージを最初の10行だけ出力し、その後は待機し続ける。（仮に、本コマンドのヘルプメッセージが10行以下だったとしたらコマンドは終了する）

```sh:
$ qvalve -h 2>&1 | qvalve -l 10
```

同じく本コマンドのヘルプメッセージを表示する際、名前付きパイプ"faucet"に書き込まれるパラメーターにより、行単位で少しずつ出力する。

```sh:
# 端末1での操作
$ mkfifo faucet
$ qvalve -h 2>&1 | qvalve -l faucet

# 端末2での操作
# （端末1と同じディレクトリーで、端末1での操作の後に実行）
$ cat > faucet
10⏎  ← 10行出力
+5⏎  ← 追加で5行出力
1E⏎  ← 1エクサ行（実質的に残り全部）を出力
```

## 注意

### コマンド終了に関する留意点

このコマンドは、指定された量の出力を終えても終了せず、入力ファイル（複数ある場合は最後のもの）がEOFになるのを待機します。言い換えれば、入力データ量がこのコマンドで指定された量よりも多い限り、コマンドは起動されたままになります。したがって次の例のように、controlfileを使わずに引数で量を直接指定し、かつ、入力データ量がその量を超えていれば、このコマンドは指定された量のデータを送り終えた後、一種のデッドロック状態になります。（ただし、SIGINTやSIGTERM等のシグナルを送れば終了する）

```sh:
$ date | qvalve 10⏎
Thu Apr  3           ←qvalveは起動したままになる（[Ctrl]+[C]で終了可能）
```

この動作には利点と欠点があります。

このコマンドと似た動作をするものとしては、有名なhead(1)コマンドがあります。head(1)コマンドは指定された量の出力後に直ちに終了しますので、デッドロックにはなりません。その代わり、自らが組み込まれているパイプの前後にあるコマンドに対してSIGPIPEやEOFを発生させる原因になるため、残されたコマンドにとっては意図しない終了やパイプ破壊になるかもしれません。

使用環境の都合に合わせ、head(1)コマンドを使うか、このコマンドを使うかを決めることをお勧めします。

#### 詳細な終了条件

このコマンドを終了させるには、次のいずれかの条件を満たす必要があります。

* このコマンドの入力ファイルをすべてクローズする（EOF状態にする）。
* SIGINTやSIGTERMなど、デフォルト動作がプロセス終了であるシグナルをこのコマンドに送る。（ただしSIGHUPを除く）
* 引数のquantityやcontrolfileで設定するパラメーターとして"`t`"コマンドを与える。
* 次の条件をすべて満たしてコマンドを起動した後、controlfileをクローズする（EOF状態にする）。
  * -tオプションを有効にする。
  * controlfileを用いる。
  * そのcontrolfileをキャラクタースペシャルファイルまたは名前付きパイプとする。

## 規格への準拠

このコマンドのソースコードはC99、IEEE Std 1003.1-2001（“POSIX.1”）に準拠させてあります。
