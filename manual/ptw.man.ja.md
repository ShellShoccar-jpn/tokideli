# PTW(1)

## 名前

ptw - 疑似端末ラッパー（フルバッファリングを解除する）

## 書式

ptw [-f] command [argument [...]]

## 説明

ptwはコマンドラッパーの一種であり、`command [argument [...]]` で実行されるコマンドに対し、その標準出力があたかも端末に繋がれているかのように見せかけます。起動されるコマンドのほとんどはANSI Cの規定に従い、実際には自分がコマンドパイプラインの途中に位置していたとしても、標準出力をフルバッファリングモードではなく行バッファリングモードにします。

類似の効果をもたらすコマンドとして stdbuf(1) があり、バッファリングモードに関しては `stdbuf -o L command [argument [...]]` を実行した時と同じ結果になることが期待されます。しかしこのコマンドは stdbuf(1) よりも強力であり、stdbuf(1) よりも多くのコマンドに作用します。実際、stdbuf(1)はLD_PRELOAD機構を利用しているため、静的リンクでビルドされたコマンドには作用しませんし、またコマンド内で独自にバッファリングモードの管理をしているPerlやPythonなどの言語コマンドにも作用しません。しかしptwコマンドは、そのようなコマンドのほとんどに対しても有効です。

「端末に繋がれているかのように見せかける」という動作をより具体的に説明すると、ptwは次の処理を行います。

1. 対象コマンドに代わって `ptw` が起動する。
1. `ptw` は疑似端末を作る。
1. `ptw` はfork(2)で子プロセスを作る。すると疑似端末が親子で共有できるようになる。
1. 子プロセス側は自分の標準出力を疑似端末のディスクリプタ（接続口）に繋ぎ変える。
1. 子プロセス側はexec(2)して `command [argument [...]]` に成り代わる。すると、commandは自分は端末に繋がれているものと判断してバッファリングモード変え、かつ本物の標準出力ではなく、親プロセスが用意した疑似端末のディスクリプタにデータを書き出すことになる。
1. 親プロセス側は、疑似端末のディスクリプタ（接続口）を監視する無限ループに入る。もしそこからデータが到来していれば、そのまま本物の標準出力へ書き出す。

## オプション

### -f

ラップするコマンドの標準出力に疑似端末を繋ぐ必要が無い場合であっても、疑似端末を繋ぎます。具体的には、ラップするコマンドがコマンドパイプラインの末端に位置している場合です。この場合は、そのコマンドはもともと本物の端末に繋がっているので疑似端末に繋ぎ変える必要はありません。このような場合、通常であればptwコマンドは疑似端末を作らず、単に対象コマンドをexec(2)するだけです。しかし、このオプションが指定された場合は必要性の有無に関わらず、疑似端末に繋ぎ変えるという処理を行います。本コマンドの動作確認をしたい場合には有用かもしれません。

## 戻り値

原則としてラップするコマンドの戻り値が返されますが、引数が不正であったり、ラップするコマンドの起動に失敗するなどにより、本コマンドが1以上戻り値を返す場合もあります。

## 使用例

perlコマンドの標準出力を疑似端末に繋ぎ変え、行バッファリングモードでの動作を促す。（ここでもしptwを使わないと、perlはフルバッファリングモードで動作し、画面にリアルアイムに秒数が表示されない）

```sh:
$ while sleep 1; do date; done | ptw perl perl -e 'while(<>){print}' | cat
```

## バグ

### フルバッファリングが解除できないコマンド

フルバッファリングに固定（内部で再設定）しているコマンドにはptwコマンドであっても効果がありません。そのようなコマンドとしてmawk(1)が知られており、Debian、Ubuntu等のLinuxディストリビューションのAWK実装がこれである場合があります。

利用しているawkコマンドがmawkである可能性がある場合には、シェルスクリプトの冒頭で次のような定義を置くことをお勧めします。

```sh:
# （シェルスクリプトの冒頭で指定する）
case $(awk -W interactive 'BEGIN{print}' 2>&1 >/dev/null) in
  '') alias awk='awk -W interactive';;
   *) alias awk='ptw awk'           ;;
esac
```

また、シェルスクリプトでできているコマンドに対しても効果がありません。その場合は、そのシェルスクリプトの中で実行しているコマンドを本コマンドで直接ラップしてください。

### 端末かどうかで挙動を変えるコマンドによる副作用

コマンドによっては、自分が端末に繋がれているかどうかで出力内容を変化させるものがあります。`ptw` でラッピングされたコマンドは自分が端末に繋がれていると思い込むため、意図しない出力が得られる場合があります。
ls(1)コマンドはそのようなコマンドの一つで、次の例ではptwでラップするかしないかで結果が変わります。

```sh:
$ ls | cat
$ ptw ls | cat
```

ptwを付けると画面幅に応じてファイル文字列を横に並べようとしますが、付けない場合は1ファイル1行で出力します。そこで、ptwを付けている場合でも1ファイル1行にしたい場合は-1オプションを使ってください。

```sh:
$ ptw ls -1 | cat
```

## 規格への準拠

このコマンドのソースコードはC99、IEEE Std 1003.1-2001（“POSIX.1”）に準拠させてあります。

## 関連項目

[PTWコマンドの役割について](ptw.info.ja.md)
