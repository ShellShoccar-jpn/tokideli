# OOBLECK(1)

## 名前

oobleck - 一定時間待っても次行が到来しない場合にのみ、現在保持中の行を出力する

## 書式

```sh:
oobleck [-d fd|file] holdingrule [file]
oobleck [-d fd|file] controlfile [file]
```

## 説明

片栗粉などにある割合で水を混ぜて作ったウーブレックという流体は、その流体の上を歩き続けている限り浮かんでいられるものの、歩くのを止めると沈んでしまいます。本コマンドの動作はこれに似ています。すなわち、データ（行指向のテキスト）が到来し続けている時のデータに対しては何もせず、破棄します。ところが、データの到来が一定時間以上止むと、最後に到来していた行を取り出して、標準出力に流します。

### 想定する用途

このコマンドが便利なのはIoTやM2Mと呼ばれる分野です。例えば、ポテンショメーターを操作し、値が変化する時だけテキストデータを出力するデバイスがあったとします。欲しい値は、摺動子（ツマミ）をいじっている最中のものではなくて、いじり終えて確定した値だけということがしばしばありますが、そのような場面でこのコマンドが役立ちます。すなわち、そのデバイスのテキストデータをこのコマンドに与えれば、最終的に確定した値だけが標準出力から得られます。

## 引数の説明

### file

データ源となるファイル。省略したり、`-`を指定した場合には標準出力と見なされます。複数指定することはできません。

### holdingrule

データ源（テキストデータ形式でなければならない）から到来した行を保持するルールを示す文字列。次の二通りの書式で指定できます。

#### a. 保持時間（ *holding-time* ）

データ源（テキストデータ形式でなければならない）から最後の行が到来してからそれを保持し続ける最長の時間。到来してからこの引数で指定した時間が経過しても次の行が到来しない場合には、現在保持している行を標準出力に送ります。

*holding-time* で指定する時間とは、最後の行の最後の1バイト（LF）が到来してから、次の行の先頭の1バイトが到来するまでの時間です。

*holding-time* の値は、次のどちらかの単位で指定できます。

* `n[.d][s|ms|us|ns]`
  * 保持する時間の長さを秒（`s`）やミリ秒（`ms`）、マイクロ秒（`us`）、ナノ秒（`ns`）で指定します。
  * 秒単位で指定する場合は、単位文字列を省略可能です。
  * 整数のみならず、小数以下を含められます。
  * 例えば1.25ミリ秒を指定するには`1.25ms`の他、`0.00125`、`0.00125s`、`1250us`などと指定できます。
* `{0|100}%`
  * `0%`とすると、最終に到来した行を保持せずに直ちに出力します。つまり、どんなに高速にデータが到来しても、そのすべてが標準出力に送られます。（0%ブロック）
  * `100%`とすると、最終に到来した行を永遠に保持し続けます。つまり、一切のデータが標準出力に送られません。（100%ブロック）
  * 両者は、controlfile（後述）指定をする際、一時的に全テータを遮断したり通過させたい場合に意味を持ちます。
  * 飽くまで`0%`か`100%`のみ指定可能であり、`12%`のような中間値は指定できません。

#### b. 行数と保持時間（ *number-of-lines* と *holding-time* ）

この書式では二つのパラメーターを指定します。後者である保持時間（ *holding-time* ）は、上記と同一のものです。

前者である行数（ *number-of-lines* ）は、保持する行数です。もし、これを *n* に設定すると、このコマンドは常に到来するデータの最新の *n* 行をメモリ上に保持します。そして設定していた保持時間（ *holding-time* ）が経過すると、それらの行を出力します。

書式は、 `number@time` であり、それぞれ次のとおりです。

* `number` は *number-of-lines* のことです。1から256までの自然数を指定できます。
* `@` は二つの値を区切るためのデリミターです。デリミターと数値の間に空白を入れてはいけません。
* `time` は *holding-time* のことです。この部分の書式は、前のセクションと同様ですのでそちらを参照してください。

### controlfile

前述の *holdingrule* の書式を満たす文字列の代わりにファイル名を指定すると、このコマンドは *controlfile* というファイルが指定されたと見なします。この場合、 *holdingrule* に相当する文字列を *controlfile* の中から読み取とろうとします。ユーザーがファイルに新しい値を書き込めば本コマンドは一定時間内にその値を反映するため、 *holdingrule* を動的に更新したい場合に便利です。

*controlfile* として用いるファイル形式は、次のいずれかを選択できます。

#### 通常ファイル

*controlfile* として通常ファイルを用いる場合、新しいパラメーターは必ず **新規作成モード（`O_CREAT`や`>`）** で書き込んでください。追記モード（`O_APPEND`や`>>`）で書き込んではいけません。理由は、通常ファイルの場合、このコマンドは常にファイルの先頭を監視するからです。

監視は0.1秒間隔で行われます。もし、書き込んだ新しいパラメーターを直ちに反映したいのであれば、ファイルを更新した後でこのコマンドに対してSIGHUPを送ってください。

#### キャラクタースペシャルファイルまたは名前付きパイプ

*controlfile* としてこれらのいずれかを用いる場合、書き込むモードは上記のどちらでも構いません。また、書き込んだ内容は直ちに反映されますのでシグナルを送る必要はありません。

パフォーマンスの観点からすると、通常ファイルよりこちらの方が有利です。

## オプション

### -d {fd|file}

通常、行を保持している間に次の行が到来した場合には、保持していた行は破棄されます。しかし、このオプションを指定していれば、破棄されずに、指定されたファイルディスクリプターやファイルに書き出されます。

整数を指定すればファイルディスクリプター番号（`fd`）が指定されたと見なされます。整数ではない文字列を指定すればファイル名（`file`）が指定されたと見なされます。もし整数名のファイルを指定したい場合には、`./2`のようにしてパスを含めてください。

## 戻り値

指定されたファイルを正常に処理できた場合にのみ0を戻します。引数・オプションが不正であったり、ファイル処理に失敗した場合には0以外を戻します。

## 使用例

9600bpsで通信しているシリアルデバイス/dev/ttyS1から完結的に到来するデータに対し、500ミリ秒経過しても次の行が到来しなかった行のみ標準出力に送る。（cu(1)コマンド併用）

```sh:
$ cu -s 9600 -l /dev/ttyS1 | oobleck 500ms
```

上記のシリアルデバイスに対し、`./control`という名前のファイルを介して行データ保持時間を間接的に指定できるようにする。また、標準出力に送られなかったデータは標準エラー出力（ファイルディスクリプター番号2）に送るようにする。

```sh:
$ cu -s 9600 -l /dev/ttyS1 | oobleck -d 2 ./control
```

## バグ

*holding-time* や、 *controlfile* の中で指定するその値にはナノ秒単位までの保持時間が指定できますが、実際にその精度の保持時間が作り出せるとは限りません。どれくらい高精度な保持時間を実現できるかはOSの状態やハードウェアの性能に依存します。

## 規格への準拠

このコマンドのソースコードはC99、IEEE Std 1003.1-2001（“POSIX.1”）に準拠させてあります。
