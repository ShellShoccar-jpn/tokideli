# VALVE(1)

## 名前

valve - データを1バイト毎または1文字毎に一定時間間隔で出力

## 書式

```sh:
valve [-c|-l] [-r|-s] [-p n] periodictime [file [...]]
valve [-c|-l] [-r|-s] [-p n] controlfile [file [...]]
```

## 説明

cat(1)が与えられたファイルをできる限り速く標準出力に書き出すのに対し、本コマンドは与えられたfileの中の各バイトまたは各行（`\n`が現れるまでの文字列）を一定の転送レートで書き出します。ただし、一つ分の書き出しを終えてから次の書き出しを始めるまでに一定時間スリープするのではなく、それぞれの書き出し始めの時刻が一定間隔になるように適宜スリープ時間を調節します。

各種引数・オプションについては別途説明します。

## 引数の説明

### file

データ源となるファイル。省略したり、`-`を指定した場合には標準出力と見なされます。複数指定することも可能です。

### periodictime

出力するバイトまたは行の転送レートを指定するためのパラメーター。書式は次の3種類から選べます。

* 各バイト・各行を書き出し始める時間間隔
  * `n[.d][s|ms|us|ns]`
* データ転送レート
  * `n[.d]{bps|kbps|Mbps|Gbps|cps}`
* バルブ開閉率
  * `{0|100}%`

#### 時間間隔の場合

数値（小数部を含めてもよい）に単位の接尾辞を付けて指定します。この場合の接尾辞は、秒を表す`s`、ミリ秒を表す`ms`、マイクロ秒を表す`us`、ナノ秒を表す`ns`のいずれかが使え、省略した場合は秒と見なされます。

例えば1.25ミリ秒を指定するには`1.25ms`の他、`0.00125`、`0.00125s`、`1250us`などと指定できます。

#### データ転送レートの場合

数値（小数部を含めてもよい）に単位の接尾辞を付けて指定します。この場合の接尾辞は、ビット毎秒を表す`bps`、キロビット毎秒を表す`kbps`、メガビット毎秒を表す`Mbps`、ギガ毎秒を表す`Gbps`、あるいはキャラクター毎秒を表す`cps`（1cps=10bps）のいずれかが使えます。省略はできません。省略した場合は秒単位の時間間隔指定と見なされます。

例えば1200bpsを指定するには`1200bps`や`1.2kbps`、`120cps`などと指定できます。

なお、この指定方法はバイト単位の出力モード（-cオプション）でのみ意味を持ちます。行単位の出力モード（-lオプション）でも指定可能ですが意味がありません。理由は、"*N*bps"が指定された場合、コマンド内部では"(8/*N*)s"という計算によって時間間隔指定に置き換えているだけだからです。

#### 開閉率の場合

接尾辞には`%`を用い、全開を表す`100%`、または全閉を表す`0%`のどちらかで指定できます。`12%`のような中間値は指定できません。（中間値におけるデータ転送レートが不明なため）

### controlfile

periodictimeではバイトまたは行の転送レートを引数によって直接的に指定していたのに対し、この方法では転送レートの書き込まれたファイルとしてcontrolfileを指定して間接的に指定します。本コマンドはcontrolfileの内容を監視するため、コマンド動作中に新しいパラメーターを書き込むことで転送レートを動的に変化させられます。

書き込むパラメーターの書式はperiodictimeと同じです。パラメーターとして無効な文字列が与えられた場合は、エラー終了せず、静かに無視します。有効なパラメーターがまだ何も与えられていない時のデフォルトは"0%"です。

controlfileとして用いるファイルとしては、次のいずれかを選択できます。

#### 通常ファイル

controlfileとして通常ファイルを用いる場合、新しいパラメーターは必ず**新規作成モード（`O_CREAT`や`>`）**で書き込んでください。追記モード（`O_APPEND`や`>>`）で書き込んではいけません。理由は、一般ファイルの場合にはファイルの先頭を監視しているからです。

監視は0.1秒間隔で行われます。もし、書き込んだ新しいパラメーターを直ちに反映したいのであれば、ファイルを更新した後でこのコマンドに対してSIGHUPを送ってください。

#### キャラクタースペシャルファイルまたは名前付きパイプ

controlfileとしてこれらのいずれかを用いる場合、書き込むモードは上記のどちらでも構いません。また、書き込んだ内容は直ちに反映されますのでシグナルを送る必要はありません。

パフォーマンスの観点からすると、通常ファイルよりこちらの方が有利です。

## オプション

### -c, -l

データの出力モードを指定します。-c、-lはそれぞれ、バイト単位出力モード、行単位出力モードを意味し、それぞれのオプションは互いに排他的です。これらがいずれも指定されなかった場合には-cが指定されたものと見なします。

バイト単位出力モードでは1バイト出力するごとにスリープし、行単位出力モードでは1行出力するごとにスリープします。

### -r, -s

1バイトまたは1行の出力ごとに行うスリープが、予定以上に長引いてしまった場合にどう対処するかのモードを指定します。-r、-sはそれぞれ、リカバリーモード、ストリクトモードを意味し、それぞれのオプションは互いに排他的です。これらがいずれも指定されなかった場合には-rが指定されたものと見なします。

各モードの意味は次のとおりです。

#### -r: リカバリーモード

通常のUNIX系OSはマルチユーザー・マルチタスクであるため、各種命令の実行時間は正確には予測できません。スリープ命令に関しても同様で、指定時間した時間に加えて余計なスリープ時間が発生し、しかもその長さは毎回異なります。

しかし、スリープを終えた後で時計を見れば、どれだけ余計なスリープをしたかはわかります。そこで、次の周回でスリープする時間を減らして遅れを取り戻すのがリカバリーモードです。このモードを使えば、遅れが累積する心配はありません。

#### -s: ストリクトモード

一方、遅れが発生した場合に、次の周回でスリープ時間を短くすると、瞬間的なデータ転送レートが上がります。もしvalveコマンドの先にIoT機器等が繋がれていて、そこに搭載されている受信バッファーが少なかった場合、データ取りこぼしが発生する恐れがあります。そこで、例え遅れが発生しても遅れを取り戻さず、指定されたデータ転送レートを守るのがこのストリクトモードです。このモードを使えば、データの取りこぼしが発生する心配はありません。

### -p *n*

（_POSIX_PRIORITY_SCHEDULINGをサポートしているOS限定）プロセス優先度設定。データ転送レート調整に用いるnanosleep()関数の動作精度を上げるため、このオプションの*n*値を2または3にすれば、プロセス優先度が上がります。*n*の範囲は0から3の4段階で、1がデフォルトです。

なお、このオプションを使うには管理者権限が必要な環境があるかもしれません。

### -u

タイムゾーンをUTCに設定します。これは環境変数TZに`UTC+0`を設定する場合と同じです。このオプションは、-cオプション指定時の表示内容に影響します。

## 戻り値

指定されたすべてのファイルを正常に処理できた場合にのみ0を戻し、引数・オプションが不正であった場合や一つでもファイル処理に失敗した場合には0以外を戻します。

## 使用例

ファイルa.txt、標準入力からのファイルb.txt、ファイルc.txtを、この順番に300bpsで出力する。

```sh:
$ cat b.txt | valve 300bps a.txt - c.txt
```

本コマンドのヘルプメッセージを1行につき0.5秒間隔で表示する。

```sh:
$ valve -h 2>&1 | valve -l 0.5s
```

同じく本コマンドのヘルプメッセージを表示する際、名前付きパイプ"faucet"に書き込まれるパラメーターによりデータ転送レートを動的に変更する。

```sh:
# 端末1での操作
$ mkfifo faucet
$ valve -h 2>&1 | valve faucet

# 端末2での操作
# （端末1と同じディレクトリーで、端末1での操作の後に実行）
$ cat > faucet
300bps⏎  ← データ転送レートを記述し、
0%⏎      ← [Enter]を押すと、
10ms⏎    ← 端末1の表示に反映される。
  :
```

シェルスクリプトで、sleep(1)コマンドよりも正確に、1秒周期で100回繰り返すループを作る。

```sh:
awk 'BEGIN{for(i=0;i<100;i++){print i}}' |
valve -l 1s                              |
while read i; do
  （ここで何らかの処理）
done
```

## バグ

コマンド自体はナノ秒単位までのデータ出力間隔指定ができますが、実際にその精度の出力間隔が作り出せるとは限りません。どれくらい高精度な出力間隔を作れるかはOSの状態やハードウェアの性能に依存します。

また、高いデータ転送レート（例えば1000Gbps）も指定できますが、その転送レートが出せるとも限りません。それもまた、OSやハードウェアの性能に依存します。

-pオプションを使えば精度を上げられるかもしれません。

## 規格への準拠

このコマンドのソースコードはC99、IEEE Std 1003.1-2001（“POSIX.1”）に準拠させてあります。
