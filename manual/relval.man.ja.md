# RELVAL(1)

## 名前

relval - 逃がし弁のように、テキストデータの流速を一定以下に保つ

## 書式

```sh:
relval [-c|-e|-z] [-d fd|file] [-ku] ratelimit [file [...]]
```

## 説明

file（省略時または`-`指定時は標準入力）をテキストデータ源として読み込んで標準出力に流しますが、その到来スピードが速すぎる場合にはratelimitで指定した速度になるように、一部の行を間引いて出力します。

ただし、到来するテキストデータの先頭列にはタイムスタンプが付与されていなければなりません。このコマンドは、実行環境の時計を見ながら実際の時間に基づいて流速制限をするのではなく、各行のタイムスタンプを読み取ることによって流速を認識します。要求するタイムスタンプのフォーマットは[tscat(1)](tscat.man.ja)コマンドと同じであり、タイムスタンプのない通常のテキストデータに対して事前にタイムスタンプを付与するためには[linets(1)](linets.man.ja)コマンドを使い、その結果を本コマンドの標準入力に与えることをお勧めします。

### 動作例

ratelimitを`2/500ms`と設定した場合には、標準出力へと通過できる行は、500ミリ秒あたり最大2行に制限されます。この状態で次のタイムスタンプ付データを与えると、

```text:
20240621000000.000 1st_line（2024-06-21 00:00:00.0に出力）
20240621000000.100 2nd_line（2024-06-21 00:00:00.1に出力）
20240621000000.200 3rd_line（2024-06-21 00:00:00.2に出力）
20240621000000.300 4th_line（2024-06-21 00:00:00.3に出力）
20240621000000.400 5th_line（2024-06-21 00:00:00.4に出力）
20240621000000.500 6th_line（2024-06-21 00:00:00.5に出力）
20240621000000.600 7th_line（2024-06-21 00:00:00.6に出力）
20240621000000.700 8th_line（2024-06-21 00:00:00.7に出力）
20240621000000.800 9th_line（2024-06-21 00:00:00.8に出力）
20240621000000.900 10th_line（2024-06-21 00:00:00.9に出力）
         :             :
```

次のように一部の行が間引かれ、さらに評価の終わったタイムスタンプ列が除去されたうえで、標準出力から出てきます。

```text:
1st_line（2024-06-21 00:00:00.0に出力）
2nd_line（2024-06-21 00:00:00.1に出力）
6th_line（2024-06-21 00:00:00.5に出力）
7th_line（2024-06-21 00:00:00.6に出力）
         :             :
```

この例では、元のテキストデータは0.1秒ごとに到来していることを意味していますが、500ミリ秒あたり最大2行という制限がかかっているため、最初の2行を出力した時点で制限に達してしまいます。この制限が解除されるのは1行目の到来から500ミリ秒後であるため、500ミリ秒が経過する前に到来した"3rd_.ine"から"5th_line"は出力されずに破棄されます。そして制限の解除された500ミリ秒後の行（"6th_line"）から再び同じ動作が繰り返されます。

通常、間引かれて破棄された行はメモリ上から消されるだけですが、後述の`-d`オプションを使うことによって（逃がし弁のドレイン管のごとく）別のファイルやディスクリプターに出力することもできます。

### テキストデータの要求仕様

既に説明したように、各行の先頭にはタイムスタンプ文字列を置かなければなりません。そして、タイムスタンプ文字列の直後には半角空白<0x20>または水平タブ<0x09>を置かなければなりません。

タイムスタンプ文字列は次の三形式が受け入れ可能であり、どの形式のタイムスタンプが付与されているかはコマンド実行時にオプションで指定する必要があります。

#### カレンダー日時形式 `YYYYMMDDhhmmss[.ddddddddd]`

年月日時分秒を表す14桁の数字で時刻を表現したものです。精度が求められる場合には、小数点以下（ナノ秒単位まで）を指定することもできます。どのタイムゾーンで表現されていても構いません（本コマンドにとってタイムゾーンは意味を持たないため）。

タイムスタンプがこの形式で付与されていることを指定するには`-c`オプションを使いますが、本コマンドではデフォルトのタイムスタンプ形式として扱われているため省略しても構いません。

#### UNIX時間形式 `n[.ddddddddd]`

UNIXエポック（UTCタイムゾーンにおける1970-01-01T00:00:00からの経過秒数）からの経過秒数で時刻を表現したものです。精度が求められる場合には、最大9桁の小数部（*ddddddddd*）を追記することもできます。

タイムスタンプがこの形式で付与されていることを指定するには`-e`オプションを指定しなくてはなりません。

#### タイムスタンプ付データ作成開始時刻形式 `n[.d]`

タイムスタンプ付データ作成開始時刻など、任意の時刻からの経過秒数で時刻を表現したものです。精度が求められる場合には、最大9桁の小数部（*ddddddddd*）を追記することもできます。

タイムスタンプがこの形式で付与されていることを指定するには`-z`オプションを指定しなくてはなりません。

## 引数の説明

### ratelimit

流速制限パラメーター。単位時間あたり、最大何行を標準入力から標準出力へ通すことを認めるかを設定します。以下に示す二種類の書式で記述します。

#### 単位時間 `n[.d][s|ms|us|ns]`

指定した単位時間あたり1行のみ通過できるように流速制限します。書式は`n[.d][s|ms|us|ns]`であり、数値部`n[.d]`と単位部`[s|ms|us|ns]`から成ります。

数値部は、0以上の整数、または実数で設定します。0は流速制限しないことを意味します。

単位部には`s`, `ms`, `us`, `ns` を数値部の直後に空白無しで記述することによって、それぞれ「秒」、「ミリ秒」、「マイクロ秒」、「ナノ秒」を指定できます。ただし、実際の動作精度は実行環境に依存します。なお、単位を省略した場合は「秒」と見なされます。

#### 最大行数と単位時間 `m/n[.d][s|ms|us|ns]`

指定した単位時間あたり、最大m行まで通過できるように流速制限します。mに指定できるのは1以上65535以下の整数です。

最大行数mの直後に空白無しでスラッシュ`/`記号を書き、さらにその直後に空白無しで単位時間を指定します。単位時間の書式は先に説明したとおりです。

### file

データ源となるテキストファイル。省略したり、`-`を指定した場合には標準出力と見なされます。複数指定することも可能です。

## オプション

### -c, -e, -z

タイムスタンプ文字列（第1列）はどのフォーマットで記録されているとみなすかを指定するためのオプションです。-c、-e、-zはそれぞれ、カレンダー日時（"YYYYMMDDhhmmzz"の14桁整数部を持つ）、UNIX時間（UTCタイムゾーンにおける1970-01-01T00:00:00からの経過秒数）、タイムスタンプ付データ作成開始時刻からの経過秒数を意味し、それぞれのオプションは互いに排他的です。これらがいずれも指定されなかった場合には-cが指定されたものと見なします。以下に、それぞれのオプションにおけるフォーマットの詳細を記します。

* -c: カレンダー日時
  * `YYYYMMDDhhmmss.ddddddddd`
* -e: UNIX時間
  * `n.ddddddddd`
* -z: データ作成開始時刻からの経過秒数
  * `N.ddddddddd`

*YYYYMMDDhhmmss*は年月日時分秒を並べた14桁の整数、*n*はUTCタイムゾーンにおける1970-01-01T00:00:00からの経過秒数、*N*はタイムスタンプ付データ作成開始時刻からの経過秒数を意味します。また、いずれの場合も秒未満の時刻を示すために最大9桁の小数部（*ddddddddd*）を付けることもできます。

なお、カレンダー日時の場合は通常、タイムゾーンによって実際の時刻の意味が変わります。しかし本コマンドではタイムゾーンが意味を持たないため、どのタイムゾーンが設定されている環境で実行しても影響ありません。

### -d {file|fd_num}

通常は間引かれた行はそのまま破棄されますが、このオプションを付けると、それらの行をfileで指定したファイルやfd_numで指定したファイルディスクリプターに出力します。本オプションは、整数を指定されるとファイルディスクリプター番号と見なすため、もし整数名のファイルを指定したい場合には、`./2`のようにしてパスを含めてください。

### -k

入力テキストデータの先頭に付加されていたタイムスタンプ列を除去せず、そのまま出力します。間引かれずに標準出力に送られる行のみならず、間引かれた場合に`-d`オプションによってその他の出力先へ送られる際も同様です。

### -u

タイムゾーンをUTCに設定します。これは環境変数TZに`UTC+0`を設定する場合と同じです。このオプションは、他コマンドとの互換性のために用意されているものであり、動作結果には全く影響を及ぼしません。

## 戻り値

指定されたすべてのファイルを正常に処理できた場合にのみ0を戻し、引数・オプションが不正であった場合や一つでもファイル処理に失敗した場合には0以外を戻します。

## 使用例

とあるwebサーバーのアクセスログ（access.log）をリアルタイムに監視する際、勢いが良すぎて目で追いきれないため、1.5秒あたり最大1行の頻度になるように間引いて表示する。（tail(1)、[linets(1)](linets.man.ja.md)コマンドを併用）

```sh:
$ tail -f access.log | linets -3 | relval 1/1.5s
```

1から100までの数を0.1秒間隔で発生させ、2秒あたり最大4行に絞り込む時、具体的に何番目の行が間引かれるか観察する。（seq(1)、nl(1)、awk(1)、[tscat(1)](tscat.man.ja.md)コマンドを併用）

```sh:
$ seq -f '%.3f' 0 0.1 9.9 | awk '{print $1,NR}' | tscat -kz | relval -z 4/2s
```
1から100までの数を0.1秒間隔で発生させ、1秒あたり最大2行に絞り込む時、具体的に何番目の行が間引かれるか観察する。（2秒あたり最大4行の場合と、1秒あたり最大2行では、間引かれる行が異なる）

```sh:
$ seq -f '%.3f' 0 0.1 9.9 | awk '{print $1,NR}' | tscat -kz | relval -z 2/1s
```

上記の例において、本来間引かれる行を出力し、本来なら間引かれない行は破棄する。（間引かれる行をドレイン管を通じて標準エラー出力に繋ぎ、間引かれない行は/dev/nullに繋いで捨てる。そして、外側で標準エラーを標準出力に繋ぐ）

```sh:
$ seq -f '%.3f' 0 0.1 9.9 | awk '{print $1,NR}' | tscat -kz | (relval -zd 2 2/1s >/dev/null) 2>&1
```

## 規格への準拠

このコマンドのソースコードはC99、IEEE Std 1003.1-2001（“POSIX.1”）に準拠させてあります。

## 関連項目

[linets(1)](linets.man.ja.md)、[tscat(1)](linets.man.ja.md)、
