# HEREWEGO(1)

## 名前

herewego - キリのいい時刻までスリープし、目覚めた（コマンド終了）時刻を表示

## 書式

```sh:
herewego [options] [+standby] interval[-premature]
```

## 説明

sleep(1)コマンドでは与えられた秒数の間スリープするのに対し、本コマンドは時計（CLOCK_REALTIME）を見て、それがキリのいい時刻になるまでスリープします。したがって、スリープ時間は一定ではありません。スリープを終えると終えた時刻を返し、直ちに終了します。

何をもってキリのいい時間とするかはintervalで指定します。例えば、intervalを`1s`にすれば時計の秒未満の桁が次に0になるまでの間スリープし、`60s`にすれば分未満が次に0になるまでの間スリープします（「引数」のセクション参照）。また、特殊な使い方として、`0`を指定することもできます。この場合スリープせずに直ちに現在時刻を表示して終了します。これは、date(1)コマンドが対応していない現在時刻の秒未満を表示するのに役立ちます（「使用例」のセクション参照）。

interval引数の直後にマイナス符号`-`に続けてprematureという時間を指定すると、キリのいい時刻になる前にスリープを終えます。スリープを終えてから時刻を返してコマンドが終了するまでには若干の時間がかかりますので、その時間を見越して早めに終了させたい場合に便利です。例えば、intervalとprematureを`1s-3ms`と設定すれば、時計の秒未満が0.997になったタイミングで現在時刻を表示して終了します（「引数」のセクション参照）。このようにしてprematureが設定されていると実際の終了時刻は早まりますが、ただし、表示される終了時刻は繰り上げられません。つまりprematureは表示される終了時刻に影響を与えません。なお、prematureで指定する時間はinterval未満の大きさでなければなりません（エラー終了する）。

interval引数の直前の引数としてプラス符号`+`に続けてstandbyという時間を指定すると、sleep(1)コマンドのように無条件にスリープする時間を指定できます。これが指定された場合は、この時間スリープした後に訪れる次のキリのいい時刻までスリープします。このような引数が求められる理由は、本コマンドがキリのいい時刻の直前に起動して処理の準備中にその瞬間が過ぎてしまうと、遅れて終了してしまうことになりますので、これを回避するためです。仮にコマンドの起動から処理開始までに30ミリ秒かかる可能性があるならば、`+30ms`と設定しておくべきです（「引数」のセクション参照）。

表示される終了時刻は、OSに設定されているタイムゾーンに準じたカレンダー時間（YYYYMMDDhhmmssの14桁数字）、UNIX時間（UTCタイムゾーンにおける1970-01-01T00:00:00からの経過秒数）、ISO 8601拡張フォーマットのいずれかをオプションで選択でき、かつ秒未満を付記することもできます。デフォルトはカレンダー時刻かつ秒未満の付記無しです。

各種引数・オプションについて詳細は、別途説明します。

## 引数の説明

### interval

キリのよい時刻と見なすための時間を設定します。厳密に言えば、時計（CLOCK_REALTIME）が指し示す時刻がこの引数で設定された時間で割り切れる瞬間をキリのいい時刻と見なします。そしてそのキリのいい時刻が次に訪れるまでスリープします。例えば、`1s`にすれば時計の秒未満の桁が次に0になるまでの間スリープし、`60s`にすれば分未満が次に0になるまでの間スリープします。

時間の書式は、数値（小数部を含めてもよい）に単位の接尾辞を付けたものです。この場合の接尾辞は、秒を表す`s`、ミリ秒を表す`ms`、マイクロ秒を表す`us`、ナノ秒を表す`ns`のいずれかが使え、省略した場合は秒と見なされます。例えば0.5秒を指定するには`0.5s`の他、`0.5`、`500ms`などと指定できます。

この引数は省略できません。

### premature

interval引数によって決められるスリープ終了時刻よりも、prematureで設定される長さだけ早期にスリープを終了します。ただし、終了時に表示される時刻はpremature引数を記述しなかった場合と同じです。例えばintervalを`1s`と設定した場合、時計の秒未満が0になったタイミングでスリープを終了しますが、その後にpremature値を付け足して`1s-3ms`とした場合、時計の秒未満が0.997になったタイミングで現在時刻を表示して終了します。

時間の書式は基本的にintervalと同じですが、interval引数の直後に空白を入れず、マイナス符号`-`を記述し、その直後に空白を入れずに記述しなければなりません。また、指定する時間はinterval未満の大きさでなければエラー終了します。

### standby

intervalによるキリのいいスリープを始める前に、この引数で設定した時間のスリープをします。

時間の書式は基本的にintervalと同じですが、この引数を記述する場合は、必ずinterval引数の一つ前の引数として記述しなければならず、また引数の最初にプラス符号`+`を置かなければなりません。

## オプション

### -0, -3, -6, -9

表示する終了時刻の精度を指定します。-0、-3、-6、-9はそれぞれ、秒単位、ミリ秒単位、マイクロ秒単位、ナノ秒単位を意味し、それぞれのオプションは互いに排他的です。これらがいずれも指定されなかった場合には-0が指定されたものと見なします。

### -c, -e, -I

表示する終了時刻のフォーマットを指定します。-c、-e、-Iはそれぞれ、カレンダー時間（"YYYYMMDDhhmmzz"の14桁整数部を持つ）、UNIX時間（UTCタイムゾーンにおける1970-01-01T00:00:00からの経過秒数）、ISO 8601拡張形式による時刻を意味し、それぞれのオプションは互いに排他的です。これらがいずれも指定されなかった場合には-cが指定されたものと見なします。以下に、それぞれのオプションにおけるフォーマットの詳細を記します。

* -c: カレンダー時間
  * `YYYYMMDDhhmmss.ddddddddd`
* -e: UNIX時間
  * `n.ddddddddd`
* -I: ISO 8601拡張形式
  * `YYYY-MM-DDThh:mm:ss,ddddddddd+hh:mm`

*YYYYMMDDhhmmss*は年月日時分秒を並べた14桁の整数、*n*はUTCタイムゾーンにおける1970-01-01T00:00:00からの経過秒数、*YYYY-MM-DDThh:mm:ss,ddddddddd+hh:mm*はISO 8601拡張形式に基づく年月日時分秒・秒未満・タイムゾーンです。また、いずれの場合も、-3、-6、-9オプションにより秒未満の時刻を示すために最大9桁の小数部（*ddddddddd*）を付けられます。

なお、14桁整数値はOSに設定されているタイムゾーンに依存します。明示的にタイムゾーンを指定したい場合には環境変数TZで設定してください。（「使用例」のセクションを参照）

### -p *n*

（_POSIX_PRIORITY_SCHEDULINGをサポートしているOS限定）プロセス優先度設定。データ転送レート調整に用いるnanosleep()関数の動作精度を上げるため、このオプションの*n*値を2または3にすれば、プロセス優先度が上がります。*n*の範囲は0から3の4段階で、1がデフォルトです。

なお、このオプションを使うには管理者権限が必要な環境があるかもしれません。

### -u

タイムゾーンをUTCに設定します。これは環境変数TZに`UTC+0`を設定する場合と同じです。このオプションは、-c、-Iオプション指定時の表示内容に影響します。

## 戻り値

正常に処理できた場合にのみ0を戻します。引数・オプションが不正であった場合、[Ctrl]+[C]などで中断された場合には0以外を戻します。

## 使用例

時計の秒の位が0秒、15秒、30秒、45秒のいずれかになる瞬間になるまでスリープする。ただし、コンピューターの終了処理に僅かな時間がかかることを想定して3ミリ秒早めに終了し、また、コマンド起動準備にも若干時間が掛かる可能性を想定して事前に0.1秒のスリープを入れる。そして、スリープ終了時刻はISO 8601拡張形式でミリ秒単位まで表示させるものとし、その時のタイムゾーンはPST-8とする。

```sh:
$ export TZ=PST-9
$ herewego -3I +0.1 15s-3ms
```

現在時刻をマイクロ秒単位まで、ISO 8601拡張形式かつJST-9タイムゾーンにて表示する。

```sh:
$ TZ=PST-9 herewego -3I 0
```

## バグ

コマンド自体はナノ秒単位までキリのいい時刻が設定でき、また、ナノ秒単位でスリープ終了時刻を表示できますが、実際にその精度の通りのスリープ動作や時刻表示ができるとは限りません。どれくらい高精度にできるかはOSの状態やハードウェアの性能に依存します。

-pオプションを使えば精度を上げられるかもしれません。

## 規格への準拠

このコマンドのソースコードはC99、IEEE Std 1003.1-2001（“POSIX.1”）に準拠させてあります。
