# WAITILL(1)

## 名前

waitill - 長さではなく期限を決めてスリープする

## 書式

```sh:
waitill [-lu] [-p n] abstime
waitill [-lu] [-p n] -e length
```

## 説明

sleep(1)コマンドを使ってスリープする際にはスリープする長さを指定します。一方、このコマンドはスリープの期限、つまりスリープを終了する時刻を指定してスリープします。スリープを期限で指定する利点は、正確なインターバルで繰り返すループを作りやすいということです。もし、*t*秒毎に何か（処理Aと呼ぶことにします）をするループを作りたいと思った場合、ループ内に"`sleep t`"を挿む方法では、そのループ所要時間は*t*秒をわずかに上回ってしまいます。なぜなら、処理Aもループ処理も実行時間が0ではないからです。そんな場合、このコマンドを使ってスリープ終了時刻を"`waitill $((t0+n*t))`"（*t*0はループを開始した時刻、*n*はループの周回数）などとすれば、処理Aやループ処理の実行時間の合計が*t*以下である限り、ループの1週は*t*秒を維持できます。

## 引数の説明

### abstime

スリープの期限（絶対時刻）。本コマンドは、ここで設定した時刻になるまでスリープを続け、その時刻が到来したら直ちに終了します。

時刻は次のいずれかの形式で指定できます。

* `YYYYMMDDhhmmss[.d]`
  * カレンダー時刻
  * "`YYYYMMDDhhmmss`"は年月日時分秒を意味する整数部です。
  * "`.d`"は小数部で、省略可能です。
  * この形式にはタイムゾーンを指定する場所がありませんが、この時刻のタイムゾーンは本コマンドを実行しているコンピューターに設定されているものが採用されます。（環境変数`TZ`や、-uオプションで変更可能）
* "`YYYY-MM-DDThh:mm:ss[,d][+hh:mm|Z]`"
  * 拡張ISO 8601形式
  * "`YYYY-MM-DDThh:mm:ss`"は年月日時分秒を意味する秒以上の部分です。
  * "`.d`"は小数部で、省略可能です。
  * "`+hh:mm`"または"`Z`"はタイムゾーンを示す部分で、省略可能です。省略した場合は、本コマンドを実行しているコンピューターに設定されているものが採用されます。（環境変数`TZ`や、-uオプションで変更可能）
* "`{+|-}n[.d]`"
  * UNIX時間（1970-01-01T00:00:00Zからの経過秒数）
  * "`n`"は整数部です。
  * "`.d`"は小数部で、省略可能です。
  * カレンダー時刻での指定と区別できるよう、整数部の前に必ず符号（"`+`"または"`-`"）を付けてください。
* `hhmmss[.d]`, `hhmm`, `mm`, `mmss.[d]`, `ss.[d]`, `.[d]`
  * カレンダー時刻の省略形
  * 指定されなかった年月日時分秒それぞれの値は、コマンド実行時の時計を参考に、一番近い未来の時刻が設定されたものと見なします。例を示します。
    1. 2025-04-12T23:56:55に、abstimeを"`57`"として実行した場合
       * "`57`"は分の単位（mm）と見なされ、秒の単位（ss）には"`00`"が設定されたものと見なされます。
       * この場合、年月日時の単位（YYYYMMDDhh）に時計の時刻をそのまま持ってくれば一番近い未来の時刻が作れます。
       * つまり、abstimeには2025-04-12T23:57:00が設定されます。
    2. 2025-04-12T23:57:05に、abstimeを"`57`"として実行した場合
       * "`57`"は分の単位（mm）と見なされ、秒の単位（ss）には"`00`"が設定されたものと見なされます。
       * この場合、年月日時の単位（YYYYMMDDhh）に時計の時刻をそのまま持ってきても、過去の時刻になってしまいます。
       * そこで、引数で指定された時の単位の一つ上の単位（この場合はhh）を+1した時刻を適用し、一番近い未来の時刻を作ります。
       * つまり、abstimeには2025-04-13T00:57:00が設定されます。
  * `mmss`や`ss`の形式では小数点を省略できません。必ず"`mmss.`"や"`ss.`"などとしてください。もし、"`1234`"や"`34`"などと記述すると、`hhmm`や`mm`として指定されたものと区別がつかず、12時34分や34分が指定されたものと見なしてしまうからです。

### length

環境変数[`WT_EPOCH`](#WT_EPOCH)に設定されている時刻からの経過秒数。-eオプション（[エポックモード](#エポックモード)）が設定されている場合には、abstimeではなくこのlengthとして解釈されます。

経過秒数は次の形式で指定できます。

* `n[.d]`
  * "`n`"は整数部です。
  * "`.d`"は小数部で、省略可能です。

この引数の詳細については、[「モード」](#モード)セクションを参照してください。

## オプション

### -e

本コマンドをエポックモードで動作させるように指示します。

詳しくは、[「モード」](#モード)セクションを参照してください。

### -l

スリープの終了時刻を次の形式で一覧表示します。

* 拡張ISO 8601形式（`YYYY-MM-DDThh:mm:ss,ddddddddd+hh:mm`）
* UNIX時間（`{+|-}n.ddddddddd`）
* カレンダー時刻（`YYYYMMDDhhmmss.ddddddddd`）

いずれの形式でも意味する時刻は同一です。また、秒未満をナノ秒単位まで表示します。

### -u

タイムゾーンをUTCに設定します。これは環境変数TZに`UTC`を設定する場合と同じです。カレンダー日時やタイムゾーン無指定ISO 8601形式によるabstimeの解釈や、-lオプションで表示される時刻に影響します。

### -p *n*

（_POSIX_PRIORITY_SCHEDULINGをサポートしているOS限定）プロセス優先度設定。データ転送レート調整に用いるnanosleep()関数の動作精度を上げるため、このオプションの*n*値を2または3にすれば、プロセス優先度が上がります。*n*の範囲は0から3の4段階で、1がデフォルトです。

なお、このオプションを使うには管理者権限が必要な環境があるかもしれません。

## 環境変数

### WT_EPOCH

[エポックモード](#エポックモード)における基準時刻を設定するための環境変数。

設定できる時刻の形式は次のとおりです。

* `YYYYMMDDhhmmss[.d]`
  * カレンダー時刻
  * "`YYYYMMDDhhmmss`"は年月日時分秒を意味する整数部です。
  * "`.d`"は小数部で、省略可能です。
  * この形式にはタイムゾーンを指定する場所がありませんが、この時刻のタイムゾーンは本コマンドを実行しているコンピューターに設定されているものが採用されます。（環境変数`TZ`や、-uオプションで変更可能）
* "`YYYY-MM-DDThh:mm:ss[,d][+hh:mm|Z]`"
  * 拡張ISO 8601形式
  * "`YYYY-MM-DDThh:mm:ss`"は年月日時分秒を意味する秒以上の部分です。
  * "`.d`"は小数部で、省略可能です。
  * "`+hh:mm`"または"`Z`"はタイムゾーンを示す部分で、省略可能です。省略した場合は、本コマンドを実行しているコンピューターに設定されているものが採用されます。（環境変数`TZ`や、-uオプションで変更可能）
* "`{+|-}n[.d]`"
  * UNIX時間（1970-01-01T00:00:00Zからの経過秒数）
  * "`n`"は整数部です。
  * "`.d`"は小数部で、省略可能です。
  * カレンダー時刻での指定と区別できるよう、整数部の前に必ず符号（"`+`"または"`-`"）を付けてください。

詳細は、[モード](#モード)セクションの中の[エポックモード](#エポックモード)の項を参照してください。

## モード

本コマンドは、-eオプション付きで起動するかどうかによって二つのモードで動作します。

### 基本モード

-eオプションなしで起動した場合のモードです。オプション直後の引数をabstimeとみなし、その時刻が到来するまでスリープします。

このモードは、使い方が単純であり、簡単です。

### エポックモード

-eオプションありで起動した場合のモードです。

オプション直後の引数をlengthとみなし、その値と環境変数[`WT_EPOCH`](#WT_EPOCH)に設定されている時刻から、スリープ期限とする時刻を計算してスリープします。具体的には次の手順です。

1. 環境変数[`WT_EPOCH`](#WT_EPOCH)に設定されている時刻と、第1引数lengthに設定されている秒数を取得します。
2. 前者に後者を足し合わせ、その時刻をスリープ終了時刻とします。

このようにして計算した時刻が到来するまでスリープします。

このモードは、ある時刻を基準としてスリープ終了時刻を設定したい場合に便利であり、プログラムの見た目をシンプルにできます。

## 戻り値

正常に処理できた場合にのみ0を戻し、引数・オプションが不正であった場合には0以外を戻します。

## 使用例

27分丁度までスリープする。（コマンドを起動した時刻がh時0分〜26分までならh時27分までスリープし、h時27分〜59分ならh+1時27分までスリープする）

```sh:
$ waitill 27
```

上記の使用法では、実際にいつまでスリープするのかわかりづらいため、スリープ期限（終了時刻）を表示する。

```sh:
$ waitill -l 27
```

基準時刻を設定し、そこから1秒後と4秒後に処理を実行するループを作る。（基準時刻の設定に[herewego(1)](herewego.man.ja.md)コマンドを利用）

```sh:
export WT_EPOCH=+$(herewego -3e 0)
n=0
while :; do
  echo "begin of the loop"
  waitill -e $((1+n*4))
  echo "task 1"
  waitill -e $((4+n*4))
  echo "task 2"
  n=$((n+1))
done
```

## バグ

コマンド自体はナノ秒単位までの精度で、スリープ期限の表示と設定ができますが、実際にその精度の出力間隔が作り出せるとは限りません。どれくらい高精度な出力間隔を作れるかはOSの状態やハードウェアの性能に依存します。

-pオプションを使えば精度を上げられるかもしれません。

## 規格への準拠

このコマンドのソースコードはC99、IEEE Std 1003.1-2001（“POSIX.1”）に準拠させてあります。
